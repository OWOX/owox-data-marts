<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manual Backfill - <?= source.constructor.name ?></title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 10px;
      background: white;
    }
    
    .warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
      color: #856404;
      font-size: 13px;
    }
    
    .form-group { 
      margin-bottom: 12px;
    }
    
    label { 
      display: block; 
      font-weight: bold; 
      margin-bottom: 6px;
      color: #333;
      font-size: 14px;
    }
    
    input { 
      width: 100%; 
      padding: 8px 12px; 
      border-radius: 4px; 
      border: 1px solid #ddd;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }
    
    input.error {
      border-color: #dc3545;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1);
    }
    
    input[type="date"] {
      width: 140px;
      max-width: 140px;
    }
    
    .field-description { 
      font-size: 12px; 
      color: #666; 
      margin-top: 4px; 
    }
    
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 4px;
      display: block;
      font-weight: bold;
    }
    
    .error-message:empty {
      display: none;
    }
    
    .buttons { 
      display: flex; 
      justify-content: flex-end; 
      gap: 12px; 
      margin-top: 10px;
    }
    
    .btn { 
      padding: 6px 14px;
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    .btn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
    }
    
    .btn-primary { 
      background: #4285f4; 
      color: #fff; 
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #3367d6;
    }
    
    .btn-secondary { 
      background: #f1f3f4; 
      color: #5f6368; 
    }
    
    .btn-secondary:hover {
      background: #e8eaed;
    }
  </style>
</head>
<body>
  <div class="warning">
    ⚠️ <strong>Note:</strong> This import will not affect your regular scheduled imports. Your connector will continue from where it left off.
  </div>
  
  <form id="manualBackfillForm">
    <? 
      var config = source.config;
      var manualBackfillFields = [];
      
      // Find fields with manualBackfill attribute
      for (var fieldName in config) {
        var field = config[fieldName];
        if (field.attributes && field.attributes.includes(CONFIG_ATTRIBUTES.MANUAL_BACKFILL)) {
          manualBackfillFields.push({
            name: fieldName,
            field: field
          });
        }
      }
      
      for (var i = 0; i < manualBackfillFields.length; i++) {
        var fieldInfo = manualBackfillFields[i];
        var fieldName = fieldInfo.name;
        var field = fieldInfo.field;
    ?>
      <div class="form-group">
        <label for="<?= fieldName ?>"><?= field.label || fieldName ?>:</label>
        <? if (field.requiredType === 'date' || field.type === 'date') { ?>
          <input type="date" id="<?= fieldName ?>" name="<?= fieldName ?>" 
                 style="width: 140px; max-width: 140px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box;"
                 value="<?= field.default ? field.default.toISOString().split('T')[0] : '' ?>" />
        <? } else if (field.requiredType === 'number' || field.type === 'number') { ?>
          <input type="number" id="<?= fieldName ?>" name="<?= fieldName ?>" 
                 value="<?= field.default || '' ?>" />
        <? } else { ?>
          <input type="text" id="<?= fieldName ?>" name="<?= fieldName ?>" 
                 value="<?= field.default || '' ?>" />
        <? } ?>
        <div class="error-message" id="<?= fieldName ?>-error"></div>
        <div class="field-description"><?= field.description || '' ?></div>
      </div>
    <? } ?>
    
    <div class="buttons">
      <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button type="button" class="btn btn-primary" id="runBtn">Run Manual Backfill</button>
    </div>
  </form>
  
  <script>
    const cancelBtn = document.getElementById('cancelBtn');
    const runBtn = document.getElementById('runBtn');
    
    cancelBtn.addEventListener('click', () => google.script.host.close());
    runBtn.addEventListener('click', runManualBackfill);
    
    function clearErrors() {
      const errorMessages = document.querySelectorAll('.error-message');
      const errorInputs = document.querySelectorAll('input.error');
      
      errorMessages.forEach(msg => {
        msg.style.display = 'none';
        msg.textContent = '';
      });
      
      errorInputs.forEach(input => {
        input.classList.remove('error');
      });
    }
    
    function showError(fieldId, message) {
      const input = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + '-error');
      
      if (input && errorDiv) {
        input.classList.add('error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        input.focus();
        return true;
      }
      return false;
    }
    
    function runManualBackfill() {
      clearErrors();
      
      const startDateInput = document.getElementById('StartDate');
      const endDateInput = document.getElementById('EndDate');
      
      if (!startDateInput || !endDateInput) {
        showError('StartDate', 'StartDate and EndDate fields not found');
        return;
      }
      
      let hasErrors = false;
      
      // Validate StartDate
      if (!startDateInput.value.trim()) {
        showError('StartDate', 'Please select Start Date');
        hasErrors = true;
      }
      
      // Validate EndDate
      if (!endDateInput.value.trim()) {
        showError('EndDate', 'Please select End Date');
        hasErrors = true;
      }
      
      // If both dates are provided, validate the range
      if (!hasErrors) {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        const today = new Date();
        
        if (endDate < startDate) {
          showError('EndDate', 'End Date cannot be earlier than Start Date');
          hasErrors = true;
        }
        
        if (startDate > today) {
          showError('StartDate', 'Start Date cannot be in the future');
          hasErrors = true;
        }
        
        if (endDate > today) {
          showError('EndDate', 'End Date cannot be in the future');
          hasErrors = true;
        }
      }
      
      if (hasErrors) {
        return;
      }
      
      const params = [];
      const inputs = document.querySelectorAll('#manualBackfillForm input');
      inputs.forEach(input => {
        if (input.value.trim()) {
          let value = input.value.trim();
          
          if (input.type === 'number') {
            value = parseFloat(value);
          }
          
          params.push({
            configField: input.name,
            value: value
          });
        }
      });    
      
      google.script.host.close();
      google.script.run.executeManualBackfill(params);
    }
  </script>
</body>
</html> 