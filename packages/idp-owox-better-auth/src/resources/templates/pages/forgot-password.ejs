<div class="space-y-6">
  <!-- Page Heading -->
  <div class="text-center">
    <h1 class="text-3xl font-semibold text-foreground tracking-tight">
      Reset password
    </h1>
  </div>
  <% if (errorMessage) { %>
    <div class="rounded-md border border-red-200 bg-red-50 text-red-700 px-4 py-3 text-sm">
      <%= errorMessage %>
    </div>
  <% } %>
  <% if (infoMessage) { %>
    <div class="rounded-md border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-3 text-sm">
      <%= infoMessage %>
    </div>
  <% } %>

  <p class="text-sm text-muted-foreground leading-relaxed">
    Enter your email to receive a secure access link to reset your password.
  </p>

  <form id="reset-form" class="space-y-4" novalidate>
    <div class="space-y-2">
      <input
        id="reset-email"
        name="email"
        type="email"
        autocomplete="email"
        required
        class="w-full rounded-md border border-border bg-background px-3 py-2.5 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
        placeholder="you.data.hero@example.com"
      />
    </div>
    <button
      id="reset-submit"
      type="submit"
      class="w-full inline-flex justify-center items-center gap-2 py-2.5 px-4 rounded-md text-sm font-medium text-white bg-primary hover:bg-primary-hover transition-all disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span id="reset-button-text">Send reset link</span>
      <svg id="reset-spinner" class="hidden animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </button>
    <p id="reset-status" class="text-sm min-h-[20px]" aria-live="polite"></p>
  </form>

  <p class="text-center text-sm text-muted-foreground">
    Remembered your password?
    <a href="/auth/sign-in" class="font-medium text-primary hover:text-primary-hover transition-colors">Return to sign in</a>
  </p>
</div>

<script>
  const magicLinkResetIntent = '<%= magicLinkResetIntent %>';
  const resetForm = document.getElementById('reset-form');
  const resetStatus = document.getElementById('reset-status');
  const resetSubmit = document.getElementById('reset-submit');
  const resetButtonText = document.getElementById('reset-button-text');
  const resetSpinner = document.getElementById('reset-spinner');

  const TIMER_KEY = 'reset_email_timer_expiry';

  function setResetStatus(message, type = 'error') {
    if (!resetStatus) return;
    resetStatus.textContent = message || '';
    resetStatus.classList.remove('text-red-600', 'text-emerald-700', 'text-blue-600');
    if (type === 'success') {
      resetStatus.classList.add('text-emerald-700');
    } else if (type === 'info') {
      resetStatus.classList.add('text-blue-600');
    } else {
      resetStatus.classList.add('text-red-600');
    }
  }

  function setButtonLoading(loading) {
    if (!resetSubmit || !resetButtonText || !resetSpinner) return;
    resetSubmit.disabled = loading;
    if (loading) {
      resetButtonText.classList.add('invisible');
      resetSpinner.classList.remove('hidden');
    } else {
      resetButtonText.classList.remove('invisible');
      resetSpinner.classList.add('hidden');
    }
  }

  function getTimeRemaining() {
    const expiry = localStorage.getItem(TIMER_KEY);
    if (!expiry) return 0;
    
    const remaining = Math.max(0, Math.floor((Number(expiry) - Date.now()) / 1000));
    if (remaining === 0) {
      localStorage.removeItem(TIMER_KEY);
    }
    return remaining;
  }

  function startTimer(seconds) {
    const expiry = Date.now() + (seconds * 1000);
    localStorage.setItem(TIMER_KEY, expiry.toString());
    updateTimerUI();
  }

  function updateTimerUI() {
    const remaining = getTimeRemaining();
    if (remaining > 0) {
      resetSubmit.disabled = true;
      setResetStatus(`Please wait ${remaining} second${remaining !== 1 ? 's' : ''} before requesting another email.`, 'info');
      setTimeout(updateTimerUI, 1000);
    } else {
      resetSubmit.disabled = false;
      setResetStatus('');
    }
  }

  // Check for existing timer on page load
  if (getTimeRemaining() > 0) {
    updateTimerUI();
  }

  async function handleReset(event) {
    event.preventDefault();
    if (!resetForm || !resetSubmit) return;

    const email = resetForm.email?.value?.trim();
    if (!email) {
      setResetStatus('Email is required.');
      return;
    }

    setButtonLoading(true);
    setResetStatus('');

    try {
      const response = await fetch('/auth/api/magic-link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, intent: magicLinkResetIntent }),
      });

      const contentType = response.headers.get('content-type') || '';
      if (!response.ok) {
        let message = 'Failed to send reset link. Please try again.';
        if (contentType.includes('application/json')) {
          const data = await response.json().catch(() => null);
          if (data?.error) message = data.error;
          // Handle rate limiting with waitSeconds from backend
          if (response.status === 429 && data?.waitSeconds) {
            setButtonLoading(false);
            startTimer(data.waitSeconds);
            return;
          }
        } else {
          const text = await response.text().catch(() => '');
          if (text) message = text;
        }
        setResetStatus(message);
        setButtonLoading(false);
        return;
      }

      // Success - start 60 second timer
      setButtonLoading(false);
      startTimer(60);
      setResetStatus('Access link sent! Check your email to reset your password.', 'success');
    } catch (error) {
      console.error('Reset access link failed', error);
      setResetStatus('Unable to send reset link. Please try again.');
      setButtonLoading(false);
    }
  }

  resetForm?.addEventListener('submit', handleReset);
</script>
